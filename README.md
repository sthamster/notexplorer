Nevoton\'s OpenTherm Explorer
===

NOTExplorer.py - утилита, позволяющая поэкспериментировать с взаимодействием по протоколу [Opentherm](https://ihormelnyk.com/Content/Pages/opentherm_library/Opentherm%20Protocol%20v2-2.pdf) между модулем шлюза, [выпускаемым компанией Невотон](https://nevoton.ru/product/modul-rasshireniya-opentherm-dlya-wiren-board-6/), и вашим котлом, поддерживающим этот протокол. Утилита предоставляет упрощённый интерфейс взаимодействия, автоматизирует рутинные операции (такие, как повторение команды в случае ошибки), и преобразует данные человеческого формата в/из формат(а) протокола Opentherm.

Утилита работает в среде контроллера [WirenBoard](https://wirenboard.com) (разрабатывалась и тестировалась на WirenBoard 6), и требует для своей работы интерпретатор Python3 (предпочтительно 3.5), и библиотеки paho-mqtt (для работы через mqtt) и/или pymodbus (для работы через serial/modbusRTU интерфейс). Питон на WB, как правило, уже стоит, а библиотеки можно поставить через pip или командами `apt-get install python3-paho-mqtt` и `apt-get install python3-pymodbus`. Выбор интерфейса зависит от того, запущен/работает ли в системе драйвер wb-mqtt-serial, сконфигурированный на поддержку вашего WBE2-I-OPENTHERM устройства. Если драйвер работает, необходимо использовать утилиту с mqtt интерфейсом, иначе - с serial/modbusRTU.

Выбор интерфейса производится ключами `-t` и `-m`. В первом случае выбирается mqtt интерфейс, и необходимо указать после ключа mqtt идентификатор вашего устройства (например, `-t wbe2-i-opentherm_11`), а во втором - имя устройства последовательного интерфейса, через которое подключен ваш шлюз (например, `-m /dev/ttyMOD1`). Опционально указываются параметры подключения к mqtt-брокеру и идентификатор modbus устройства.

**Внимание!** При использовании интерфейса последовательного доступа (ключ `-m`) соответствующее устройство не должно использоваться штатным шлюзом mqtt<->serial (т.е., например, `fuser -v /dev/ttyMOD1` не должен показывать процесса wb-mqtt-serial). Ну и наоборот, если вы хотите использовать mqtt интерфейс, убедитесь, что штатный шлюз надлежащим образом сконфигурирован и ваше устройство доступно через стандартный интерфейс WirenBoard.

Утилита реализует команды:
`read <data-id>[/<data-value>]` - чтение ячейки ведомого устройства
`write <data-id> <data-value>` - запись ячейки ведомого устройства
`readtsp <paramStart>[-<ParamFinish>]` - чтение "прозрачного" параметра (Transparent Slave Parameter (TSP))
`writetsp <paramN> <ParamValue>` - запись "прозрачного" параметра
`readerr <errN>` - чтение записи из истории сбоев (Fault-History-Buffer (FHB))
`scan` - чтение всех известных программе ячеек opentherm ведомого устройства
`fullscan [<start-id>[-<finish-id>]]` - сплошное чтение всех ячеек opentherm ведомого устройства
`cmd` - запуск утилиты в интерактивном режиме, при котором можно выполнять индивидуальные команды, описанные выше, без переинициализации интерфейса

Все команды, кроме `cmd`, можно задавать в командной строке несколько раз, в любой последовательности

При задании ключа `-v` (а также при запуске в интерактивном режиме), утилита выводит на экран подробности выполняемых операций, и декодирует считанные из ячеек opentherm данные в человекочитаемый формат.

При выполнении команды `write` можно использовать суффиксы форматирования, для преобразования указанных данных в формат, специфичный для конкретной ячейки opentherm. Например: `write 8 12.5%F8.8` или `write 126 3%HB`

При задании ключа `-r` утилита будет пытаться повторить (до пяти раз) команду, если при её выполнении возникла устранимая ошибка.

При задании ключа `-l` утилита будет писать протокол своей работы в указанный лог-файл, а при указании, дополнительно, ключа `-d` этот протокол будет содержать много отладочной информации.


Примеры использования:

Чтение ячейки конфигурации котла через mqtt интерфейс у устройства `wbe2-i-opentherm_11`
`./NOTExplorer.py -t wbe2-i-opentherm_11 -r read 3`

Сброс блокировки котла через mqtt интерфейс
`./NOTExplorer.py -t wbe2-i-opentherm_11 -r -l log -d -v write 4 1%HB`

Выдача устройству с идентификатором 11 через последовательный интерфейс `/dev/ttyMOD1` последовательности команд на: запись через opentherm в ячейку 2 (котла) значения 27, чтение ячейки 0 с одновременной передачей установленных битов 0 и 3 старшего байта данных (состояние "CH enable" + "OTC active"), запись температуры 50 градусов в ячейку 1, чтение ячеек 3 и 5
`./NOTExplorer.py -m /dev/ttyMOD1 -a 11 -r -l log w 2 27 r 0/1%HB0+1%HB3 w 1 50%F8.8 r 3 r 5`

Полное сканирование на чтение всех opentherm ячеек
`./NOTExplorer.py -m /dev/ttyMOD1 -r -l log -d -v f`


P.P.S. Последняя версия программы доступна в https://github.com/sthamster/notexplorer
P.S. Ну и, конечно, любопытные могут посмотреть в программе, в коде класса OTDecoder, инициализацию коллекции `self.otd`, где, собстенно, и сосредоточены основные знания по ячейкам opentherm устройств...

